<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Cardápio Digital</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <img id="logo" src="/placeholder.svg?height=60&width=60" alt="Logo" class="logo">
                <div class="header-info">
                    <h1 id="empresa-nome">Carregando...</h1>
                    <div class="status-container">
                        <span id="status-funcionamento" class="status"></span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="cart-btn" onclick="toggleCart()">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cart-count" class="cart-count">0</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <div id="categorias-nav" class="nav-categories">
                <!-- Categorias serão inseridas aqui via JavaScript -->
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Produtos em Destaque -->
            <section id="destaques" class="section">
                <h2 class="section-title">
                    <i class="fas fa-star"></i>
                    Destaques
                </h2>
                <div id="produtos-destaque" class="products-grid">
                    <!-- Produtos em destaque serão inseridos aqui -->
                </div>
            </section>

            <!-- Categorias de Produtos -->
            <div id="categorias-produtos">
                <!-- Seções de categorias serão inseridas aqui -->
            </div>
        </div>
    </main>

    <!-- Carrinho Lateral -->
    <div id="cart-sidebar" class="cart-sidebar">
        <div class="cart-header">
            <h3><i class="fas fa-shopping-cart"></i> Seu Pedido</h3>
            <button class="close-cart" onclick="toggleCart()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="cart-items" class="cart-items">
            <!-- Itens do carrinho serão inseridos aqui -->
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <strong>Total: R$ <span id="cart-total">0,00</span></strong>
            </div>
            <button id="checkout-btn" class="checkout-btn" onclick="finalizarPedido()">
                <i class="fab fa-whatsapp"></i>
                Finalizar Pedido
            </button>
        </div>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="overlay" onclick="toggleCart()"></div>

    <!-- Modal de Produto -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeProductModal()">&times;</span>
            <div id="modal-body">
                <!-- Conteúdo do modal será inserido aqui -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <h3 id="footer-nome">Nome da Empresa</h3>
                    <p id="footer-endereco">Endereço</p>
                    <p id="footer-telefone">Telefone</p>
                </div>
                <div class="footer-social">
                    <a id="instagram-link" href="#" target="_blank">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a id="facebook-link" href="#" target="_blank">
                        <i class="fab fa-facebook"></i>
                    </a>
                </div>
                <div class="footer-payment">
                    <h4>Formas de Pagamento</h4>
                    <div id="payment-methods" class="payment-methods">
                        <!-- Métodos de pagamento serão inseridos aqui -->
                    </div>
                </div>
                <div class="footer-admin">
                  <a href="admin.html" class="admin-link">
                    <i class="fas fa-cog"></i>
                    Painel Admin
                  </a>
                </div>
            </div>
        </div>
    </footer>

    <script src="config.js"></script>
    <script>
        // Variáveis globais
        let carrinho = [];
        let categoriaAtiva = '';

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', async function() {
            // Mostrar loading
            document.body.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100vh; color: white; font-size: 1.2rem;"><i class="fas fa-spinner fa-spin" style="margin-right: 1rem;"></i>Carregando cardápio...</div>';
            
            // Carregar configurações do servidor
            await carregarConfiguracoes();
            
            // Recriar o HTML original
            document.body.innerHTML = `
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <img id="logo" src="/placeholder.svg?height=60&width=60" alt="Logo" class="logo">
                    <div class="header-info">
                        <h1 id="empresa-nome">Carregando...</h1>
                        <div class="status-container">
                            <span id="status-funcionamento" class="status"></span>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="cart-btn" onclick="toggleCart()">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="cart-count" class="cart-count">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <div class="container">
                <div id="categorias-nav" class="nav-categories">
                    <!-- Categorias serão inseridas aqui via JavaScript -->
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main">
            <div class="container">
                <!-- Produtos em Destaque -->
                <section id="destaques" class="section">
                    <h2 class="section-title">
                        <i class="fas fa-star"></i>
                        Destaques
                    </h2>
                    <div id="produtos-destaque" class="products-grid">
                        <!-- Produtos em destaque serão inseridos aqui -->
                    </div>
                </section>

                <!-- Categorias de Produtos -->
                <div id="categorias-produtos">
                    <!-- Seções de categorias serão inseridas aqui -->
                </div>
            </div>
        </main>

        <!-- Carrinho Lateral -->
        <div id="cart-sidebar" class="cart-sidebar">
            <div class="cart-header">
                <h3><i class="fas fa-shopping-cart"></i> Seu Pedido</h3>
                <button class="close-cart" onclick="toggleCart()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="cart-items" class="cart-items">
                <!-- Itens do carrinho serão inseridos aqui -->
            </div>
            <div class="cart-footer">
                <div class="cart-total">
                    <strong>Total: R$ <span id="cart-total">0,00</span></strong>
                </div>
                <button id="checkout-btn" class="checkout-btn" onclick="finalizarPedido()">
                    <i class="fab fa-whatsapp"></i>
                    Finalizar Pedido
                </button>
            </div>
        </div>

        <!-- Overlay -->
        <div id="overlay" class="overlay" onclick="toggleCart()"></div>

        <!-- Modal de Produto -->
        <div id="product-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeProductModal()">&times;</span>
                <div id="modal-body">
                    <!-- Conteúdo do modal será inserido aqui -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-info">
                        <h3 id="footer-nome">Nome da Empresa</h3>
                        <p id="footer-endereco">Endereço</p>
                        <p id="footer-telefone">Telefone</p>
                    </div>
                    <div class="footer-social">
                        <a id="instagram-link" href="#" target="_blank">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a id="facebook-link" href="#" target="_blank">
                            <i class="fab fa-facebook"></i>
                        </a>
                    </div>
                    <div class="footer-payment">
                        <h4>Formas de Pagamento</h4>
                        <div id="payment-methods" class="payment-methods">
                            <!-- Métodos de pagamento serão inseridos aqui -->
                        </div>
                    </div>
                    <div class="footer-admin">
                      <a href="admin.html" class="admin-link">
                        <i class="fas fa-cog"></i>
                        Painel Admin
                      </a>
                    </div>
                </div>
            </div>
        </footer>
    `;
            
            // Reinicializar a aplicação
            inicializarApp();
        });

// Modificar a função inicializarApp para recarregar dados sempre
async function inicializarApp() {
    // Sempre carregar configurações mais recentes
    carregarConfiguracoes()
    
    carregarInformacoesEmpresa();
    verificarHorarioFuncionamento();
    carregarCategorias();
    carregarProdutos();
    carregarFormasPagamento();
    atualizarCarrinho();
}

// Adicionar listener para detectar mudanças nas configurações
window.addEventListener('storage', function(e) {
    if (e.key === 'menuConfig' || e.key === 'menuItems') {
        // Recarregar página quando configurações mudarem
        location.reload();
    }
});

// Adicionar listener para evento customizado
window.addEventListener('configUpdated', function(e) {
    // Atualizar configurações locais
    Object.assign(CONFIG, e.detail.config);
    Object.assign(menuItems, e.detail.menuItems);
    
    // Reinicializar a aplicação
    inicializarApp();
});

// Adicionar verificação periódica de atualizações
setInterval(function() {
    const lastUpdate = localStorage.getItem('lastUpdate');
    const currentUpdate = window.lastKnownUpdate || '';
    
    if (lastUpdate && lastUpdate !== currentUpdate) {
        window.lastKnownUpdate = lastUpdate;
        carregarConfiguracoes();
        inicializarApp();
    }
}, 2000); // Verificar a cada 2 segundos

// Inicializar lastKnownUpdate
window.lastKnownUpdate = localStorage.getItem('lastUpdate') || '';

        function carregarInformacoesEmpresa() {
            document.getElementById('page-title').textContent = `${CONFIG.empresa.nome} - Cardápio Digital`;
            document.getElementById('empresa-nome').textContent = CONFIG.empresa.nome;
            document.getElementById('logo').src = CONFIG.empresa.logo;
            document.getElementById('footer-nome').textContent = CONFIG.empresa.nome;
            document.getElementById('footer-endereco').textContent = CONFIG.empresa.endereco;
            document.getElementById('footer-telefone').textContent = CONFIG.empresa.telefone;
            
            if (CONFIG.empresa.instagram) {
                document.getElementById('instagram-link').href = `https://instagram.com/${CONFIG.empresa.instagram.replace('@', '')}`;
            }
            if (CONFIG.empresa.facebook) {
                document.getElementById('facebook-link').href = `https://facebook.com/${CONFIG.empresa.facebook}`;
            }
        }

        function verificarHorarioFuncionamento() {
            if (!CONFIG.horarioFuncionamento.ativo) {
                document.getElementById('status-funcionamento').innerHTML = 
                    '<span class="status-open"><i class="fas fa-clock"></i> Sempre Aberto</span>';
                return;
            }

            const agora = new Date();
            const diaSemana = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'][agora.getDay()];
            const horarioHoje = CONFIG.horarioFuncionamento.horarios[diaSemana];

            if (!horarioHoje.aberto) {
                document.getElementById('status-funcionamento').innerHTML = 
                    '<span class="status-closed"><i class="fas fa-times-circle"></i> Fechado hoje</span>';
                return;
            }

            const horaAtual = agora.getHours() * 60 + agora.getMinutes();
            const [horaAbertura, minutoAbertura] = horarioHoje.abertura.split(':').map(Number);
            const [horaFechamento, minutoFechamento] = horarioHoje.fechamento.split(':').map(Number);
            
            const minutosAbertura = horaAbertura * 60 + minutoAbertura;
            let minutosFechamento = horaFechamento * 60 + minutoFechamento;
            
            // Se o fechamento é no dia seguinte (ex: 00:00)
            if (minutosFechamento < minutosAbertura) {
                minutosFechamento += 24 * 60;
            }

            const aberto = horaAtual >= minutosAbertura && horaAtual <= minutosFechamento;

            if (aberto) {
                document.getElementById('status-funcionamento').innerHTML = 
                    `<span class="status-open"><i class="fas fa-check-circle"></i> Aberto até ${horarioHoje.fechamento}</span>`;
            } else {
                document.getElementById('status-funcionamento').innerHTML = 
                    `<span class="status-closed"><i class="fas fa-times-circle"></i> Fechado - Abre às ${horarioHoje.abertura}</span>`;
            }
        }

        function carregarCategorias() {
            const navCategorias = document.getElementById('categorias-nav');
            const categoriasAtivas = CONFIG.categorias.filter(cat => cat.ativo);

            navCategorias.innerHTML = categoriasAtivas.map(categoria => `
                <button class="nav-category ${categoria.id === categoriaAtiva ? 'active' : ''}" 
                        onclick="scrollToCategory('${categoria.id}')">
                    <span class="category-icon">${categoria.icone}</span>
                    ${categoria.nome}
                </button>
            `).join('');
        }

        function carregarProdutos() {
            // Carregar produtos em destaque
            const produtosDestaque = CONFIG.produtos.filter(produto => produto.destaque && produto.disponivel);
            const containerDestaque = document.getElementById('produtos-destaque');
            
            if (produtosDestaque.length > 0) {
                containerDestaque.innerHTML = produtosDestaque.map(produto => criarCardProduto(produto)).join('');
            } else {
                document.getElementById('destaques').style.display = 'none';
            }

            // Carregar produtos por categoria
            const containerCategorias = document.getElementById('categorias-produtos');
            const categoriasAtivas = CONFIG.categorias.filter(cat => cat.ativo);

            containerCategorias.innerHTML = categoriasAtivas.map(categoria => {
                const produtosCategoria = CONFIG.produtos.filter(produto => 
                    produto.categoria === categoria.id && produto.disponivel
                );

                if (produtosCategoria.length === 0) return '';

                return `
                    <section id="categoria-${categoria.id}" class="section">
                        <h2 class="section-title">
                            <span class="category-icon">${categoria.icone}</span>
                            ${categoria.nome}
                        </h2>
                        <div class="products-grid">
                            ${produtosCategoria.map(produto => criarCardProduto(produto)).join('')}
                        </div>
                    </section>
                `;
            }).join('');
        }

        function criarCardProduto(produto) {
            return `
                <div class="product-card" onclick="openProductModal(${produto.id})">
                    <div class="product-image">
                        <img src="${produto.imagem}" alt="${produto.nome}" loading="lazy">
                        ${produto.destaque ? '<span class="product-badge">Destaque</span>' : ''}
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">${produto.nome}</h3>
                        <p class="product-description">${produto.descricao}</p>
                        ${CONFIG.configuracoes.mostraPrecos ? `
                            <div class="product-price">R$ ${produto.preco.toFixed(2).replace('.', ',')}</div>
                        ` : ''}
                        <button class="add-to-cart-btn" onclick="event.stopPropagation(); adicionarAoCarrinho(${produto.id})">
                            <i class="fas fa-plus"></i>
                            Adicionar
                        </button>
                    </div>
                </div>
            `;
        }

        function carregarFormasPagamento() {
            const container = document.getElementById('payment-methods');
            const metodos = [];

            if (CONFIG.pagamento.pix.ativo) {
                metodos.push('<i class="fas fa-qrcode" title="PIX"></i>');
            }
            if (CONFIG.pagamento.dinheiro.ativo) {
                metodos.push('<i class="fas fa-money-bill-wave" title="Dinheiro"></i>');
            }
            if (CONFIG.pagamento.cartao.ativo) {
                metodos.push('<i class="fas fa-credit-card" title="Cartão"></i>');
            }

            container.innerHTML = metodos.join('');
        }

        function scrollToCategory(categoriaId) {
            const elemento = document.getElementById(`categoria-${categoriaId}`);
            if (elemento) {
                elemento.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            categoriaAtiva = categoriaId;
            carregarCategorias();
        }

        function openProductModal(produtoId) {
            const produto = CONFIG.produtos.find(p => p.id === produtoId);
            if (!produto) return;

            const modal = document.getElementById('product-modal');
            const modalBody = document.getElementById('modal-body');

            modalBody.innerHTML = `
                <div class="modal-product">
                    <img src="${produto.imagem}" alt="${produto.nome}" class="modal-product-image">
                    <div class="modal-product-info">
                        <h2>${produto.nome}</h2>
                        <p class="modal-product-description">${produto.descricao}</p>
                        ${CONFIG.configuracoes.mostraPrecos ? `
                            <div class="modal-product-price">R$ ${produto.preco.toFixed(2).replace('.', ',')}</div>
                        ` : ''}
                        <div class="modal-actions">
                            <button class="modal-add-btn" onclick="adicionarAoCarrinho(${produto.id}); closeProductModal();">
                                <i class="fas fa-plus"></i>
                                Adicionar ao Pedido
                            </button>
                        </div>
                    </div>
                </div>
            `;

            modal.style.display = 'block';
        }

        function closeProductModal() {
            document.getElementById('product-modal').style.display = 'none';
        }

        function adicionarAoCarrinho(produtoId) {
            const produto = CONFIG.produtos.find(p => p.id === produtoId);
            if (!produto) return;

            const itemExistente = carrinho.find(item => item.id === produtoId);
            
            if (itemExistente) {
                itemExistente.quantidade++;
            } else {
                carrinho.push({
                    id: produto.id,
                    nome: produto.nome,
                    preco: produto.preco,
                    quantidade: 1
                });
            }

            atualizarCarrinho();
            mostrarNotificacao('Item adicionado ao carrinho!');
        }

        function removerDoCarrinho(produtoId) {
            carrinho = carrinho.filter(item => item.id !== produtoId);
            atualizarCarrinho();
        }

        function alterarQuantidade(produtoId, novaQuantidade) {
            const item = carrinho.find(item => item.id === produtoId);
            if (item) {
                if (novaQuantidade <= 0) {
                    removerDoCarrinho(produtoId);
                } else {
                    item.quantidade = novaQuantidade;
                    atualizarCarrinho();
                }
            }
        }

        function atualizarCarrinho() {
            const cartCount = document.getElementById('cart-count');
            const cartItems = document.getElementById('cart-items');
            const cartTotal = document.getElementById('cart-total');

            const totalItens = carrinho.reduce((total, item) => total + item.quantidade, 0);
            const totalPreco = carrinho.reduce((total, item) => total + (item.preco * item.quantidade), 0);

            cartCount.textContent = totalItens;
            cartTotal.textContent = totalPreco.toFixed(2).replace('.', ',');

            if (carrinho.length === 0) {
                cartItems.innerHTML = '<div class="cart-empty">Seu carrinho está vazio</div>';
            } else {
                cartItems.innerHTML = carrinho.map(item => `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <h4>${item.nome}</h4>
                            <div class="cart-item-price">R$ ${item.preco.toFixed(2).replace('.', ',')}</div>
                        </div>
                        <div class="cart-item-controls">
                            <button onclick="alterarQuantidade(${item.id}, ${item.quantidade - 1})">-</button>
                            <span>${item.quantidade}</span>
                            <button onclick="alterarQuantidade(${item.id}, ${item.quantidade + 1})">+</button>
                            <button class="remove-btn" onclick="removerDoCarrinho(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function toggleCart() {
            const sidebar = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('overlay');
            
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('active');
                overlay.classList.add('active');
            }
        }

        function finalizarPedido() {
            if (carrinho.length === 0) {
                alert('Seu carrinho está vazio!');
                return;
            }

            if (!CONFIG.configuracoes.whatsappPedidos) {
                alert('Pedidos via WhatsApp não estão disponíveis no momento.');
                return;
            }

            let mensagem = `🍔 *Novo Pedido - ${CONFIG.empresa.nome}*\n\n`;
            
            carrinho.forEach(item => {
                mensagem += `• ${item.quantidade}x ${item.nome}\n`;
                mensagem += `  R$ ${item.preco.toFixed(2).replace('.', ',')} cada\n\n`;
            });

            const total = carrinho.reduce((total, item) => total + (item.preco * item.quantidade), 0);
            mensagem += `💰 *Total: R$ ${total.toFixed(2).replace('.', ',')}*\n\n`;
            
            if (CONFIG.pagamento.delivery.ativo) {
                mensagem += `🚚 Taxa de entrega: R$ ${CONFIG.pagamento.delivery.taxa.toFixed(2).replace('.', ',')}\n`;
                mensagem += `⏰ Tempo estimado: ${CONFIG.pagamento.delivery.tempoEntrega}\n\n`;
            }

            mensagem += `📍 Endereço de entrega: _Por favor, informe seu endereço_\n\n`;
            mensagem += `💳 Forma de pagamento: _Por favor, informe como deseja pagar_`;

            const whatsappUrl = `https://wa.me/${CONFIG.configuracoes.numeroWhatsapp}?text=${encodeURIComponent(mensagem)}`;
            window.open(whatsappUrl, '_blank');
        }

        function mostrarNotificacao(mensagem) {
            // Criar elemento de notificação
            const notificacao = document.createElement('div');
            notificacao.className = 'notification';
            notificacao.textContent = mensagem;
            
            document.body.appendChild(notificacao);
            
            // Mostrar notificação
            setTimeout(() => notificacao.classList.add('show'), 100);
            
            // Remover notificação após 3 segundos
            setTimeout(() => {
                notificacao.classList.remove('show');
                setTimeout(() => document.body.removeChild(notificacao), 300);
            }, 3000);
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('product-modal');
            if (event.target === modal) {
                closeProductModal();
            }
        }

        // Atualizar horário a cada minuto
        setInterval(verificarHorarioFuncionamento, 60000);
    </script>
</body>
</html>
