<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo</title>
    <link rel="stylesheet" href="stylesadmin.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>üè™ Painel Administrativo</h1>
            <div class="header-controls">
                <div class="store-status">
                    <label class="switch">
                        <input type="checkbox" id="store-toggle">
                        <span class="slider"></span>
                    </label>
                    <span id="status-text">Fechado</span>
                </div>
            </div>
        </header>

        <nav class="admin-nav">
            <button class="nav-btn active" data-section="dashboard">Dashboard</button>
            <button class="nav-btn" data-section="products">Produtos</button>
            <button class="nav-btn" data-section="categories">Categorias</button>
            <button class="nav-btn" data-section="addons">Acr√©scimos</button>
            <button class="nav-btn" data-section="orders">Pedidos</button>
            <button class="nav-btn" data-section="settings">Configura√ß√µes</button>
        </nav>

        <main class="admin-main">
            <!-- Dashboard -->
            <section id="dashboard" class="admin-section active">
                <h2>Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Pedidos Hoje</h3>
                        <div class="stat-number" id="orders-today">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Faturamento Hoje</h3>
                        <div class="stat-number" id="revenue-today">R$ 0,00</div>
                    </div>
                    <div class="stat-card">
                        <h3>Produtos Ativos</h3>
                        <div class="stat-number" id="active-products">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Status da Loja</h3>
                        <div class="stat-number" id="store-status">Fechado</div>
                    </div>
                </div>
                
                <div class="recent-orders">
                    <h3>Pedidos Recentes</h3>
                    <div id="recent-orders-list"></div>
                </div>
            </section>

            <!-- Produtos -->
            <section id="products" class="admin-section">
                <div class="section-header">
                    <h2>Produtos</h2>
                    <button id="add-product-btn" class="btn-primary">+ Adicionar Produto</button>
                </div>
                <div id="products-list"></div>
            </section>

            <!-- Categorias -->
            <section id="categories" class="admin-section">
                <div class="section-header">
                    <h2>Categorias</h2>
                    <button id="add-category-btn" class="btn-primary">+ Adicionar Categoria</button>
                </div>
                <div id="categories-list"></div>
            </section>

            <!-- Acr√©scimos -->
            <section id="addons" class="admin-section">
                <div class="section-header">
                    <h2>Acr√©scimos</h2>
                    <button id="add-addon-btn" class="btn-primary">+ Adicionar Acr√©scimo</button>
                </div>
                <div id="addons-list"></div>
            </section>

            <!-- Pedidos -->
            <section id="orders" class="admin-section">
                <h2>Pedidos</h2>
                <div class="orders-filters">
                    <select id="order-status-filter">
                        <option value="">Todos os Status</option>
                        <option value="pending">Pendente</option>
                        <option value="confirmed">Confirmado</option>
                        <option value="preparing">Preparando</option>
                        <option value="ready">Pronto</option>
                        <option value="delivered">Entregue</option>
                        <option value="cancelled">Cancelado</option>
                    </select>
                    <button id="refresh-orders" class="btn-primary">üîÑ Atualizar</button>
                </div>
                <div id="orders-list"></div>
            </section>

            <!-- Configura√ß√µes -->
            <section id="settings" class="admin-section">
                <h2>Configura√ß√µes</h2>
                <form id="settings-form">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>Nome da Loja:</label>
                            <input type="text" id="store-name-setting">
                        </div>
                        
                        <div class="form-group">
                            <label>Telefone:</label>
                            <input type="tel" id="store-phone-setting">
                        </div>
                        
                        <div class="form-group">
                            <label>Endere√ßo:</label>
                            <input type="text" id="store-address-setting">
                        </div>
                        
                        <div class="form-group">
                            <label>Hor√°rio de Abertura:</label>
                            <input type="time" id="opening-time-setting">
                        </div>
                        
                        <div class="form-group">
                            <label>Hor√°rio de Fechamento:</label>
                            <input type="time" id="closing-time-setting">
                        </div>
                        
                        <div class="form-group">
                            <label>Taxa de Entrega (R$):</label>
                            <input type="number" step="0.01" id="delivery-fee-setting">
                        </div>
                        
                        <div class="form-group">
                            <label>Chave PIX:</label>
                            <input type="text" id="pix-key-setting">
                        </div>

                        <div class="form-group">
                            <label>WhatsApp (com c√≥digo do pa√≠s):</label>
                            <input type="text" id="whatsapp-number-setting" placeholder="5511999999999">
                            <small>Exemplo: 5511999999999 (55 + DDD + n√∫mero)</small>
                        </div>

                        <!-- Novos campos para cores -->
                        <div class="form-group">
                            <label>Cor do Cabe√ßalho (In√≠cio):</label>
                            <input type="color" id="header-color-start-setting">
                        </div>
                        <div class="form-group">
                            <label>Cor do Cabe√ßalho (Fim):</label>
                            <input type="color" id="header-color-end-setting">
                        </div>
                        <div class="form-group">
                            <label>Cor de Fundo do Card√°pio:</label>
                            <input type="color" id="background-color-setting">
                        </div>

                        <!-- Novo campo para dias de funcionamento -->
                        <div class="form-group full-width">
                            <label>Dias de Funcionamento:</label>
                            <div class="days-checkbox-group">
                                <label><input type="checkbox" id="day-0" value="0"> Domingo</label>
                                <label><input type="checkbox" id="day-1" value="1"> Segunda-feira</label>
                                <label><input type="checkbox" id="day-2" value="2"> Ter√ßa-feira</label>
                                <label><input type="checkbox" id="day-3" value="3"> Quarta-feira</label>
                                <label><input type="checkbox" id="day-4" value="4"> Quinta-feira</label>
                                <label><input type="checkbox" id="day-5" value="5"> Sexta-feira</label>
                                <label><input type="checkbox" id="day-6" value="6"> S√°bado</label>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary">Salvar Configura√ß√µes</button>
                </form>
            </section>
        </main>
    </div>

    <!-- Modal para Produto -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="product-modal-title">Adicionar Produto</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="form-group">
                    <label>Nome:</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o:</label>
                    <textarea id="product-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Pre√ßo (R$):</label>
                    <input type="number" step="0.01" id="product-price" required>
                </div>
                <div class="form-group">
                    <label>Categoria:</label>
                    <select id="product-category" required></select>
                </div>
                <div class="form-group">
                    <label>URL da Imagem:</label>
                    <input type="url" id="product-image">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="product-active" checked>
                        Produto Ativo
                    </label>
                </div>
                <button type="submit" class="btn-primary">Salvar</button>
            </form>
        </div>
    </div>

    <!-- Modal para Categoria -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="category-modal-title">Adicionar Categoria</h2>
            <form id="category-form">
                <input type="hidden" id="category-id">
                <div class="form-group">
                    <label>Nome:</label>
                    <input type="text" id="category-name" required>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o:</label>
                    <textarea id="category-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="category-active" checked>
                        Categoria Ativa
                    </label>
                </div>
                <button type="submit" class="btn-primary">Salvar</button>
            </form>
        </div>
    </div>

    <!-- Modal para Acr√©scimo -->
    <div id="addon-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="addon-modal-title">Adicionar Acr√©scimo</h2>
            <form id="addon-form">
                <input type="hidden" id="addon-id">
                <div class="form-group">
                    <label>Nome:</label>
                    <input type="text" id="addon-name" required>
                </div>
                <div class="form-group">
                    <label>Pre√ßo (R$):</label>
                    <input type="number" step="0.01" id="addon-price" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="addon-active" checked>
                        Acr√©scimo Ativo
                    </label>
                </div>
                <button type="submit" class="btn-primary">Salvar</button>
            </form>
        </div>
    </div>

    <script>
        // ===== CONFIGURA√á√ÉO DO SUPABASE =====
        // SUBSTITUA PELAS SUAS CREDENCIAIS
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        
        // Verificar se as credenciais foram configuradas
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            alert('‚ö†Ô∏è ATEN√á√ÉO: Configure as credenciais do Supabase no arquivo admin.html!\n\nSubstitua YOUR_SUPABASE_URL e YOUR_SUPABASE_ANON_KEY pelas suas credenciais.');
        }
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== VARI√ÅVEIS GLOBAIS =====
        let currentSection = 'dashboard';
        let categories = [];
        let products = [];
        let orders = [];
        let settings = {};
        let addons = [];

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando painel administrativo...');
            
            try {
                await initializeAdmin();
                setupEventListeners();
                console.log('‚úÖ Painel administrativo carregado com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar:', error);
                alert('Erro ao carregar painel. Verifique as credenciais do Supabase.');
            }
        });

        // ===== CONFIGURAR EVENT LISTENERS =====
        function setupEventListeners() {
            console.log('üîß Configurando event listeners...');
            
            // Navega√ß√£o
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchSection(this.dataset.section);
                });
            });

            // Toggle da loja
            const storeToggle = document.getElementById('store-toggle');
            if (storeToggle) {
                storeToggle.addEventListener('change', toggleStore);
            }

            // Bot√µes de adicionar
            const addProductBtn = document.getElementById('add-product-btn');
            const addCategoryBtn = document.getElementById('add-category-btn');
            const addAddonBtn = document.getElementById('add-addon-btn');
            const refreshOrdersBtn = document.getElementById('refresh-orders');
            
            if (addProductBtn) addProductBtn.addEventListener('click', () => openProductModal());
            if (addCategoryBtn) addCategoryBtn.addEventListener('click', () => openCategoryModal());
            if (addAddonBtn) addAddonBtn.addEventListener('click', () => openAddonModal());
            if (refreshOrdersBtn) refreshOrdersBtn.addEventListener('click', loadOrders);

            // Formul√°rios
            const productForm = document.getElementById('product-form');
            const categoryForm = document.getElementById('category-form');
            const addonForm = document.getElementById('addon-form');
            const settingsForm = document.getElementById('settings-form');
            
            if (productForm) productForm.addEventListener('submit', saveProduct);
            if (categoryForm) categoryForm.addEventListener('submit', saveCategory);
            if (addonForm) addonForm.addEventListener('submit', saveAddon);
            if (settingsForm) settingsForm.addEventListener('submit', saveSettings);

            // Modais
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });

            // Filtro de pedidos
            const orderFilter = document.getElementById('order-status-filter');
            if (orderFilter) {
                orderFilter.addEventListener('change', loadOrders);
            }

            console.log('‚úÖ Event listeners configurados!');
        }

        // ===== INICIALIZAR ADMIN =====
        async function initializeAdmin() {
            console.log('üìä Carregando dados...');
            
            await loadSettings();
            await loadCategories();
            await loadProducts();
            await loadAddons();
            await loadOrders();
            
            updateStoreStatus();
            loadDashboard();
            
            console.log('‚úÖ Dados carregados!');
        }

        // ===== ALTERNAR SE√á√ÉO =====
        function switchSection(section) {
            console.log(`üîÑ Mudando para se√ß√£o: ${section}`);
            
            // Remover classe active de todas as se√ß√µes e bot√µes
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            // Adicionar classe active na se√ß√£o e bot√£o atual
            const sectionElement = document.getElementById(section);
            const buttonElement = document.querySelector(`[data-section="${section}"]`);
            
            if (sectionElement) sectionElement.classList.add('active');
            if (buttonElement) buttonElement.classList.add('active');
            
            currentSection = section;

            // Carregar dados espec√≠ficos da se√ß√£o
            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'products':
                    displayProducts();
                    break;
                case 'categories':
                    displayCategories();
                    break;
                case 'addons':
                    displayAddons();
                    break;
                case 'orders':
                    displayOrders();
                    break;
                case 'settings':
                    displaySettings();
                    break;
            }
        }

        // ===== CARREGAR CONFIGURA√á√ïES =====
        async function loadSettings() {
            try {
                console.log('‚öôÔ∏è Carregando configura√ß√µes...');
                
                const { data, error } = await supabase
                    .from('settings')
                    .select('*');

                if (error) throw error;

                settings = {};
                data.forEach(setting => {
                    settings[setting.key] = setting.value;
                });

                // Parse active_days from string to array
                if (settings.active_days) {
                    try {
                        settings.active_days = JSON.parse(settings.active_days);
                    } catch (e) {
                        console.error("Erro ao parsear active_days:", e);
                        settings.active_days = []; // Fallback para array vazio em caso de erro
                    }
                } else {
                    settings.active_days = [];
                }

                console.log('‚úÖ Configura√ß√µes carregadas:', settings);
            } catch (error) {
                console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
            }
        }

        // ===== CARREGAR CATEGORIAS =====
        async function loadCategories() {
            try {
                console.log('üìÇ Carregando categorias...');
                
                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .order('name');

                if (error) throw error;
                categories = data || [];
                
                console.log(`‚úÖ ${categories.length} categorias carregadas`);
            } catch (error) {
                console.error('‚ùå Erro ao carregar categorias:', error);
                categories = [];
            }
        }

        // ===== CARREGAR PRODUTOS =====
        async function loadProducts() {
            try {
                console.log('üõçÔ∏è Carregando produtos...');
                
                const { data, error } = await supabase
                    .from('products')
                    .select(`
                        *,
                        categories (name)
                    `)
                    .eq('active', true) // Apenas produtos ativos
                    .order('name');

                if (error) throw error;
                products = data || [];
                
                console.log(`‚úÖ ${products.length} produtos carregados`);
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos:', error);
                products = [];
            }
        }

        // ===== CARREGAR ACR√âSCIMOS =====
        async function loadAddons() {
            try {
                console.log('‚ûï Carregando acr√©scimos...');
                
                const { data, error } = await supabase
                    .from('addons')
                    .select('*')
                    .eq('active', true) // Apenas acr√©scimos ativos
                    .order('name');

                if (error) throw error;
                addons = data || [];
                
                console.log(`‚úÖ ${addons.length} acr√©scimos carregados`);
            } catch (error) {
                console.error('‚ùå Erro ao carregar acr√©scimos:', error);
                addons = [];
            }
        }

        // ===== CARREGAR PEDIDOS =====
        async function loadOrders() {
            try {
                console.log('üìã Carregando pedidos...');
                
                const statusFilter = document.getElementById('order-status-filter')?.value || '';
                let query = supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (statusFilter) {
                    query = query.eq('status', statusFilter);
                }

                const { data, error } = await query;

                if (error) throw error;
                orders = data || [];

                console.log(`‚úÖ ${orders.length} pedidos carregados`);
                
                if (currentSection === 'orders') {
                    displayOrders();
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar pedidos:', error);
                orders = [];
            }
        }

        // ===== CARREGAR DASHBOARD =====
        async function loadDashboard() {
            try {
                console.log('üìä Carregando dashboard...');
                
                // Pedidos de hoje
                const today = new Date().toISOString().split('T')[0];
                const { data: todayOrders, error: ordersError } = await supabase
                    .from('orders')
                    .select('*')
                    .gte('created_at', today + 'T00:00:00')
                    .lte('created_at', today + 'T23:59:59');

                if (ordersError) throw ordersError;

                // Calcular estat√≠sticas
                const ordersCount = todayOrders?.length || 0;
                const revenue = todayOrders?.reduce((sum, order) => sum + parseFloat(order.total_amount || 0), 0) || 0;
                const activeProducts = products.filter(p => p.active).length;

                // Atualizar dashboard
                const ordersElement = document.getElementById('orders-today');
                const revenueElement = document.getElementById('revenue-today');
                const productsElement = document.getElementById('active-products');
                const statusElement = document.getElementById('store-status');

                if (ordersElement) ordersElement.textContent = ordersCount;
                if (revenueElement) revenueElement.textContent = `R$ ${revenue.toFixed(2).replace('.', ',')}`;
                if (productsElement) productsElement.textContent = activeProducts;
                if (statusElement) statusElement.textContent = settings.store_open === 'true' ? 'Aberto' : 'Fechado';

                // Pedidos recentes
                const recentOrders = todayOrders?.slice(0, 5) || [];
                displayRecentOrders(recentOrders);

                console.log('‚úÖ Dashboard atualizado!');
            } catch (error) {
                console.error('‚ùå Erro ao carregar dashboard:', error);
            }
        }

        // ===== EXIBIR PEDIDOS RECENTES =====
        function displayRecentOrders(orders) {
            const container = document.getElementById('recent-orders-list');
            if (!container) return;
            
            if (orders.length === 0) {
                container.innerHTML = '<p>Nenhum pedido hoje.</p>';
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <strong>#${order.id}</strong>
                        <span class="order-status status-${order.status}">${getStatusText(order.status)}</span>
                    </div>
                    <div class="order-info">
                        <p><strong>${order.customer_name}</strong> - ${order.customer_phone}</p>
                        <p>R$ ${parseFloat(order.total_amount || 0).toFixed(2).replace('.', ',')}</p>
                        <small>${new Date(order.created_at).toLocaleString('pt-BR')}</small>
                    </div>
                </div>
            `).join('');
        }

        // ===== EXIBIR PRODUTOS =====
        function displayProducts() {
            const container = document.getElementById('products-list');
            if (!container) return;
            
            if (products.length === 0) {
                container.innerHTML = '<p>Nenhum produto cadastrado.</p>';
                return;
            }

            container.innerHTML = products.map(product => `
                <div class="item-card">
                    <div class="item-info">
                        <h3>${product.name}</h3>
                        <p>${product.description || ''}</p>
                        <p><strong>R$ ${parseFloat(product.price || 0).toFixed(2).replace('.', ',')}</strong></p>
                        <p><small>Categoria: ${product.categories?.name || 'N/A'}</small></p>
                        <span class="status-badge ${product.active ? 'active' : 'inactive'}">
                            ${product.active ? 'Ativo' : 'Inativo'}
                        </span>
                    </div>
                    <div class="item-actions">
                        <button onclick="editProduct(${product.id})" class="btn-edit">Editar</button>
                        <button onclick="deleteProduct(${product.id})" class="btn-delete">Excluir</button>
                    </div>
                </div>
            `).join('');
        }

        // ===== EXIBIR CATEGORIAS =====
        function displayCategories() {
            const container = document.getElementById('categories-list');
            if (!container) return;
            
            if (categories.length === 0) {
                container.innerHTML = '<p>Nenhuma categoria cadastrada.</p>';
                return;
            }

            container.innerHTML = categories.map(category => `
                <div class="item-card">
                    <div class="item-info">
                        <h3>${category.name}</h3>
                        <p>${category.description || ''}</p>
                        <span class="status-badge ${category.active ? 'active' : 'inactive'}">
                            ${category.active ? 'Ativa' : 'Inativa'}
                        </span>
                    </div>
                    <div class="item-actions">
                        <button onclick="editCategory(${category.id})" class="btn-edit">Editar</button>
                        <button onclick="deleteCategory(${category.id})" class="btn-delete">Excluir</button>
                    </div>
                </div>
            `).join('');
        }

        // ===== EXIBIR ACR√âSCIMOS =====
        function displayAddons() {
            const container = document.getElementById('addons-list');
            if (!container) return;
            
            if (addons.length === 0) {
                container.innerHTML = '<p>Nenhum acr√©scimo cadastrado.</p>';
                return;
            }

            container.innerHTML = addons.map(addon => `
                <div class="item-card">
                    <div class="item-info">
                        <h3>${addon.name}</h3>
                        <p><strong>R$ ${parseFloat(addon.price || 0).toFixed(2).replace('.', ',')}</strong></p>
                        <span class="status-badge ${addon.active ? 'active' : 'inactive'}">
                            ${addon.active ? 'Ativo' : 'Inativo'}
                        </span>
                    </div>
                    <div class="item-actions">
                        <button onclick="editAddon(${addon.id})" class="btn-edit">Editar</button>
                        <button onclick="deleteAddon(${addon.id})" class="btn-delete">Excluir</button>
                    </div>
                </div>
            `).join('');
        }

        // ===== EXIBIR PEDIDOS =====
        function displayOrders() {
            const container = document.getElementById('orders-list');
            if (!container) return;
            
            if (orders.length === 0) {
                container.innerHTML = '<p>Nenhum pedido encontrado.</p>';
                return;
            }

            container.innerHTML = orders.map(order => {
                const orderItems = JSON.parse(order.items || '[]');
                const itemsHtml = orderItems.map(item => {
                    let itemAddonsHtml = '';
                    if (item.selectedAddons && item.selectedAddons.length > 0) {
                        itemAddonsHtml = item.selectedAddons.map(addon => `
                            <li style="font-size: 0.85em; color: #555;">+ ${addon.name} (R$ ${parseFloat(addon.price).toFixed(2).replace('.', ',')})</li>
                        `).join('');
                        itemAddonsHtml = `<ul style="list-style: none; padding-left: 10px; margin-top: 5px;">${itemAddonsHtml}</ul>`;
                    }
                    return `
                        <div class="order-item">
                            ${item.quantity}x ${item.name} - R$ ${(item.price * item.quantity).toFixed(2).replace('.', ',')}
                            ${itemAddonsHtml}
                        </div>
                    `;
                }).join('');

                return `
                    <div class="order-card">
                        <div class="order-header">
                            <strong>#${order.id}</strong>
                            <select onchange="updateOrderStatus(${order.id}, this.value)" class="status-select">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pendente</option>
                                <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmado</option>
                                <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparando</option>
                                <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Pronto</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Entregue</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelado</option>
                            </select>
                        </div>
                        <div class="order-details">
                            <p><strong>Cliente:</strong> ${order.customer_name}</p>
                            <p><strong>Telefone:</strong> ${order.customer_phone}</p>
                            <p><strong>Tipo:</strong> ${order.delivery_type === 'delivery' ? 'Entrega' : 'Retirada'}</p>
                            ${order.customer_address ? `<p><strong>Endere√ßo:</strong> ${order.customer_address}</p>` : ''}
                            <p><strong>Pagamento:</strong> ${getPaymentText(order.payment_method)}</p>
                            ${order.change_for ? `<p><strong>Troco para:</strong> R$ ${parseFloat(order.change_for).toFixed(2).replace('.', ',')}</p>` : ''}
                            <p><strong>Total:</strong> R$ ${parseFloat(order.total_amount || 0).toFixed(2).replace('.', ',')}</p>
                            <p><strong>Data:</strong> ${new Date(order.created_at).toLocaleString('pt-BR')}</p>
                            
                            <div class="order-items">
                                <h4>Itens:</h4>
                                ${itemsHtml}
                            </div>
                            <button onclick="printOrder(${order.id})" class="btn-print">Imprimir Pedido</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===== EXIBIR CONFIGURA√á√ïES =====
        function displaySettings() {
            const elements = {
                'store-name-setting': settings.store_name || '',
                'store-phone-setting': settings.store_phone || '',
                'store-address-setting': settings.store_address || '',
                'opening-time-setting': settings.opening_time || '',
                'closing-time-setting': settings.closing_time || '',
                'delivery-fee-setting': settings.delivery_fee || '',
                'pix-key-setting': settings.pix_key || '',
                'whatsapp-number-setting': settings.whatsapp_number || '',
                'header-color-start-setting': settings.header_color_start || '#667eea', // Default
                'header-color-end-setting': settings.header_color_end || '#764ba2',   // Default
                'background-color-setting': settings.background_color || '#f8f9fa'    // Default
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.value = value;
            });

            // Preencher checkboxes de dias de funcionamento
            document.querySelectorAll('.days-checkbox-group input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = settings.active_days.includes(parseInt(checkbox.value));
            });
        }

        // ===== TOGGLE DA LOJA =====
        async function toggleStore() {
            const isOpen = document.getElementById('store-toggle')?.checked || false;
            
            try {
                console.log(`üè™ ${isOpen ? 'Abrindo' : 'Fechando'} loja...`);
                
                const { error } = await supabase
                    .from('settings')
                    .update({ value: isOpen.toString() })
                    .eq('key', 'store_open');

                if (error) throw error;

                settings.store_open = isOpen.toString();
                const statusText = document.getElementById('status-text');
                if (statusText) statusText.textContent = isOpen ? 'Aberto' : 'Fechado';
                
                if (currentSection === 'dashboard') {
                    loadDashboard();
                }

                console.log(`‚úÖ Loja ${isOpen ? 'aberta' : 'fechada'}!`);
            } catch (error) {
                console.error('‚ùå Erro ao alterar status da loja:', error);
                alert('Erro ao alterar status da loja');
            }
        }

        // ===== MODAL DE PRODUTO =====
        function openProductModal(productId = null) {
            const modal = document.getElementById('product-modal');
            const title = document.getElementById('product-modal-title');
            const form = document.getElementById('product-form');
            
            if (!modal || !title || !form) return;
            
            // Limpar formul√°rio
            form.reset();
            document.getElementById('product-id').value = '';
            
            // Carregar categorias no select
            const categorySelect = document.getElementById('product-category');
            if (categorySelect) {
                categorySelect.innerHTML = categories.map(cat => 
                    `<option value="${cat.id}">${cat.name}</option>`
                ).join('');
            }

            if (productId) {
                // Editar produto
                const product = products.find(p => p.id === productId);
                if (product) {
                    title.textContent = 'Editar Produto';
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-description').value = product.description || '';
                    document.getElementById('product-price').value = product.price;
                    document.getElementById('product-category').value = product.category_id;
                    document.getElementById('product-image').value = product.image_url || '';
                    document.getElementById('product-active').checked = product.active;
                }
            } else {
                // Novo produto
                title.textContent = 'Adicionar Produto';
                document.getElementById('product-active').checked = true;
            }

            modal.style.display = 'block';
        }

        // ===== MODAL DE CATEGORIA =====
        function openCategoryModal(categoryId = null) {
            const modal = document.getElementById('category-modal');
            const title = document.getElementById('category-modal-title');
            const form = document.getElementById('category-form');
            
            if (!modal || !title || !form) return;
            
            // Limpar formul√°rio
            form.reset();
            document.getElementById('category-id').value = '';

            if (categoryId) {
                // Editar categoria
                const category = categories.find(c => c.id === categoryId);
                if (category) {
                    title.textContent = 'Editar Categoria';
                    document.getElementById('category-id').value = category.id;
                    document.getElementById('category-name').value = category.name;
                    document.getElementById('category-description').value = category.description || '';
                    document.getElementById('category-active').checked = category.active;
                }
            } else {
                // Nova categoria
                title.textContent = 'Adicionar Categoria';
                document.getElementById('category-active').checked = true;
            }

            modal.style.display = 'block';
        }

        // ===== MODAL DE ACR√âSCIMO =====
        function openAddonModal(addonId = null) {
            const modal = document.getElementById('addon-modal');
            const title = document.getElementById('addon-modal-title');
            const form = document.getElementById('addon-form');
            
            if (!modal || !title || !form) return;
            
            // Limpar formul√°rio
            form.reset();
            document.getElementById('addon-id').value = '';
            
            if (addonId) {
                // Editar acr√©scimo
                const addon = addons.find(a => a.id === addonId);
                if (addon) {
                    title.textContent = 'Editar Acr√©scimo';
                    document.getElementById('addon-id').value = addon.id;
                    document.getElementById('addon-name').value = addon.name;
                    document.getElementById('addon-price').value = addon.price;
                    document.getElementById('addon-active').checked = addon.active;
                }
            } else {
                // Novo acr√©scimo
                title.textContent = 'Adicionar Acr√©scimo';
                document.getElementById('addon-active').checked = true;
            }

            modal.style.display = 'block';
        }

        // ===== SALVAR PRODUTO =====
        async function saveProduct(e) {
            e.preventDefault();
            
            const productId = document.getElementById('product-id')?.value;
            const productData = {
                name: document.getElementById('product-name')?.value,
                description: document.getElementById('product-description')?.value,
                price: parseFloat(document.getElementById('product-price')?.value || 0),
                category_id: parseInt(document.getElementById('product-category')?.value || 0),
                image_url: document.getElementById('product-image')?.value || null,
                active: document.getElementById('product-active')?.checked || false
            };

            try {
                console.log('üíæ Salvando produto...', productData);
                
                let result;
                if (productId) {
                    // Atualizar
                    result = await supabase
                        .from('products')
                        .update(productData)
                        .eq('id', productId);
                } else {
                    // Inserir
                    result = await supabase
                        .from('products')
                        .insert([productData]);
                }

                if (result.error) throw result.error;

                document.getElementById('product-modal').style.display = 'none';
                await loadProducts();
                displayProducts();
                
                console.log('‚úÖ Produto salvo com sucesso!');
                alert('Produto salvo com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao salvar produto:', error);
                alert('Erro ao salvar produto: ' + error.message);
            }
        }

        // ===== SALVAR CATEGORIA =====
        async function saveCategory(e) {
            e.preventDefault();
            
            const categoryId = document.getElementById('category-id')?.value;
            const categoryData = {
                name: document.getElementById('category-name')?.value,
                description: document.getElementById('category-description')?.value,
                active: document.getElementById('category-active')?.checked || false
            };

            try {
                console.log('üíæ Salvando categoria...', categoryData);
                
                let result;
                if (categoryId) {
                    // Atualizar
                    result = await supabase
                        .from('categories')
                        .update(categoryData)
                        .eq('id', categoryId);
                } else {
                    // Inserir
                    result = await supabase
                        .from('categories')
                        .insert([categoryData]);
                }

                if (result.error) throw result.error;

                document.getElementById('category-modal').style.display = 'none';
                await loadCategories();
                displayCategories();
                
                console.log('‚úÖ Categoria salva com sucesso!');
                alert('Categoria salva com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao salvar categoria:', error);
                alert('Erro ao salvar categoria: ' + error.message);
            }
        }

        // ===== SALVAR ACR√âSCIMO =====
        async function saveAddon(e) {
            e.preventDefault();
            
            const addonId = document.getElementById('addon-id')?.value;
            const addonData = {
                name: document.getElementById('addon-name')?.value,
                price: parseFloat(document.getElementById('addon-price')?.value || 0),
                active: document.getElementById('addon-active')?.checked || false
            };

            try {
                console.log('üíæ Salvando acr√©scimo...', addonData);
                
                let result;
                if (addonId) {
                    // Atualizar
                    result = await supabase
                        .from('addons')
                        .update(addonData)
                        .eq('id', addonId);
                } else {
                    // Inserir
                    result = await supabase
                        .from('addons')
                        .insert([addonData]);
                }

                if (result.error) throw result.error;

                document.getElementById('addon-modal').style.display = 'none';
                await loadAddons();
                displayAddons();
                
                console.log('‚úÖ Acr√©scimo salvo com sucesso!');
                alert('Acr√©scimo salvo com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao salvar acr√©scimo:', error);
                alert('Erro ao salvar acr√©scimo: ' + error.message);
            }
        }

        // ===== SALVAR CONFIGURA√á√ïES =====
        async function saveSettings(e) {
            e.preventDefault();
            
            // Coletar dias de funcionamento
            const activeDays = Array.from(document.querySelectorAll('.days-checkbox-group input[type="checkbox"]:checked'))
                                .map(checkbox => parseInt(checkbox.value));

            const settingsData = [
                { key: 'store_name', value: document.getElementById('store-name-setting')?.value || '' },
                { key: 'store_phone', value: document.getElementById('store-phone-setting')?.value || '' },
                { key: 'store_address', value: document.getElementById('store-address-setting')?.value || '' },
                { key: 'opening_time', value: document.getElementById('opening-time-setting')?.value || '' },
                { key: 'closing_time', value: document.getElementById('closing-time-setting')?.value || '' },
                { key: 'delivery_fee', value: document.getElementById('delivery-fee-setting')?.value || '' },
                { key: 'pix_key', value: document.getElementById('pix-key-setting')?.value || '' },
                { key: 'whatsapp_number', value: document.getElementById('whatsapp-number-setting')?.value || '' },
                { key: 'header_color_start', value: document.getElementById('header-color-start-setting')?.value || '#667eea' },
                { key: 'header_color_end', value: document.getElementById('header-color-end-setting')?.value || '#764ba2' },
                { key: 'background_color', value: document.getElementById('background-color-setting')?.value || '#f8f9fa' },
                { key: 'active_days', value: JSON.stringify(activeDays) } // Salvar como string JSON
            ];

            try {
                console.log('üíæ Salvando configura√ß√µes...');
                
                for (const setting of settingsData) {
                    const { error } = await supabase
                        .from('settings')
                        .upsert({ 
                            key: setting.key, 
                            value: setting.value,
                            updated_at: new Date().toISOString()
                        }, { 
                            onConflict: 'key' 
                        });

                    if (error) throw error;
                }

                await loadSettings(); // Recarregar configura√ß√µes para atualizar o estado global
                
                console.log('‚úÖ Configura√ß√µes salvas com sucesso!');
                alert('Configura√ß√µes salvas com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao salvar configura√ß√µes:', error);
                alert('Erro ao salvar configura√ß√µes: ' + error.message);
            }
        }

        // ===== FUN√á√ïES DE EDI√á√ÉO E EXCLUS√ÉO =====
        function editProduct(productId) {
            openProductModal(productId);
        }

        function editCategory(categoryId) {
            openCategoryModal(categoryId);
        }

        function editAddon(addonId) {
            openAddonModal(addonId);
        }

        async function deleteProduct(productId) {
            if (!confirm('Tem certeza que deseja excluir este produto?')) return;

            try {
                console.log(`üóëÔ∏è Excluindo produto ${productId}...`);
                
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);

                if (error) throw error;

                await loadProducts();
                displayProducts();
                
                console.log('‚úÖ Produto exclu√≠do com sucesso!');
                alert('Produto exclu√≠do com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao excluir produto:', error);
                alert('Erro ao excluir produto: ' + error.message);
            }
        }

        async function deleteCategory(categoryId) {
            if (!confirm('Tem certeza que deseja excluir esta categoria?')) return;

            try {
                console.log(`üóëÔ∏è Excluindo categoria ${categoryId}...`);
                
                const { error } = await supabase
                    .from('categories')
                    .delete()
                    .eq('id', categoryId);

                if (error) throw error;

                await loadCategories();
                displayCategories();
                
                console.log('‚úÖ Categoria exclu√≠da com sucesso!');
                alert('Categoria exclu√≠da com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao excluir categoria:', error);
                alert('Erro ao excluir categoria: ' + error.message);
            }
        }

        async function deleteAddon(addonId) {
            if (!confirm('Tem certeza que deseja excluir este acr√©scimo?')) return;

            try {
                console.log(`üóëÔ∏è Excluindo acr√©scimo ${addonId}...`);
                
                const { error } = await supabase
                    .from('addons')
                    .delete()
                    .eq('id', addonId);

                if (error) throw error;

                await loadAddons();
                displayAddons();
                
                console.log('‚úÖ Acr√©scimo exclu√≠do com sucesso!');
                alert('Acr√©scimo exclu√≠do com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao excluir acr√©scimo:', error);
                alert('Erro ao excluir acr√©scimo: ' + error.message);
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                console.log(`üìã Atualizando status do pedido ${orderId} para ${newStatus}...`);
                
                const { error } = await supabase
                    .from('orders')
                    .update({ status: newStatus })
                    .eq('id', orderId);

                if (error) throw error;

                await loadOrders();
                
                console.log('‚úÖ Status do pedido atualizado!');
            } catch (error) {
                console.error('‚ùå Erro ao atualizar status do pedido:', error);
                alert('Erro ao atualizar status do pedido: ' + error.message);
            }
        }

        // ===== FUN√á√ÉO DE IMPRESS√ÉO DE PEDIDO =====
        function printOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                alert('Pedido n√£o encontrado para impress√£o.');
                return;
            }

            const orderItems = JSON.parse(order.items || '[]');
            const itemsHtml = orderItems.map(item => {
                let itemAddonsHtml = '';
                let itemTotalPrice = item.price * item.quantity;
                if (item.selectedAddons && item.selectedAddons.length > 0) {
                    itemAddonsHtml = item.selectedAddons.map(addon => {
                        itemTotalPrice += addon.price * item.quantity; // Adiciona o pre√ßo do acr√©scimo ao total do item
                        return `<p style="margin-left: 15px; font-size: 0.9em;">+ ${addon.name} (R$ ${parseFloat(addon.price).toFixed(2).replace('.', ',')})</p>`;
                    }).join('');
                }
                return `
                    <tr>
                        <td>${item.quantity}x ${item.name}</td>
                        <td style="text-align: right;">R$ ${item.price.toFixed(2).replace('.', ',')}</td>
                    </tr>
                    ${itemAddonsHtml}
                `;
            }).join('');

            const subtotal = parseFloat(order.total_amount || 0) - parseFloat(order.delivery_fee || 0);

            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Pedido #${order.id}</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; color: #333; }
                        .receipt-header { text-align: center; margin-bottom: 20px; }
                        .receipt-header h1 { font-size: 1.8em; margin-bottom: 5px; color: #007bff; }
                        .receipt-header p { font-size: 0.9em; color: #666; }
                        .order-details-print { margin-bottom: 20px; border-bottom: 1px dashed #ccc; padding-bottom: 15px; }
                        .order-details-print p { margin-bottom: 5px; }
                        .order-details-print strong { color: #007bff; }
                        .items-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .items-table th, .items-table td { border-bottom: 1px solid #eee; padding: 8px 0; text-align: left; }
                        .items-table th { background-color: #f8f9fa; }
                        .totals-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        .totals-table td { padding: 5px 0; text-align: right; }
                        .totals-table .total-line { font-weight: bold; font-size: 1.1em; border-top: 1px solid #ccc; padding-top: 10px; }
                        .totals-table .total-final { font-size: 1.3em; color: #28a745; }
                        .footer-print { text-align: center; margin-top: 30px; font-size: 0.8em; color: #999; }
                        @media print {
                            body { margin: 0; }
                            .receipt-header, .order-details-print, .items-table, .totals-table, .footer-print { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="receipt-header">
                        <h1>${settings.store_name || 'Card√°pio Digital'}</h1>
                        <p>${settings.store_address || ''}</p>
                        <p>${settings.store_phone || ''}</p>
                        <h2>PEDIDO #${order.id}</h2>
                        <p>${new Date(order.created_at).toLocaleString('pt-BR')}</p>
                    </div>

                    <div class="order-details-print">
                        <p><strong>Cliente:</strong> ${order.customer_name}</p>
                        <p><strong>Telefone:</strong> ${order.customer_phone}</p>
                        <p><strong>Tipo:</strong> ${order.delivery_type === 'delivery' ? 'Entrega' : 'Retirada'}</p>
                        ${order.customer_address ? `<p><strong>Endere√ßo:</strong> ${order.customer_address}</p>` : ''}
                        <p><strong>Pagamento:</strong> ${getPaymentText(order.payment_method)}</p>
                        ${order.payment_method === 'pix' ? `<p><strong>Chave PIX:</strong> ${settings.pix_key || 'N√£o configurado'}</p>` : ''}
                        ${order.change_for ? `<p><strong>Troco para:</strong> R$ ${parseFloat(order.change_for).toFixed(2).replace('.', ',')}</p>` : ''}
                        <p><strong>Status:</strong> ${getStatusText(order.status)}</p>
                    </div>

                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th style="text-align: right;">Pre√ßo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>

                    <table class="totals-table">
                        <tr>
                            <td>Subtotal:</td>
                            <td>R$ ${subtotal.toFixed(2).replace('.', ',')}</td>
                        </tr>
                        ${order.delivery_fee > 0 ? `
                        <tr>
                            <td>Taxa de Entrega:</td>
                            <td>R$ ${parseFloat(order.delivery_fee || 0).toFixed(2).replace('.', ',')}</td>
                        </tr>` : ''}
                        <tr class="total-line">
                            <td>Total:</td>
                            <td class="total-final">R$ ${parseFloat(order.total_amount || 0).toFixed(2).replace('.', ',')}</td>
                        </tr>
                    </table>

                    <div class="footer-print">
                        <p>Obrigado pelo seu pedido!</p>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close(); // Importante para o documento estar pronto

            printWindow.onload = function() {
                printWindow.print();
                // printWindow.close(); // Opcional: fechar ap√≥s imprimir
            };
        }

        // ===== FUN√á√ïES AUXILIARES =====
        function updateStoreStatus() {
            const isOpen = settings.store_open === 'true';
            const toggle = document.getElementById('store-toggle');
            const statusText = document.getElementById('status-text');
            
            if (toggle) toggle.checked = isOpen;
            if (statusText) statusText.textContent = isOpen ? 'Aberto' : 'Fechado';
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pendente',
                'confirmed': 'Confirmado',
                'preparing': 'Preparando',
                'ready': 'Pronto',
                'delivered': 'Entregue',
                'cancelled': 'Cancelado'
            };
            return statusMap[status] || status;
        }

        function getPaymentText(method) {
            const methodMap = {
                'pix': 'PIX',
                'money': 'Dinheiro',
                'card': 'Cart√£o'
            };
            return methodMap[method] || method;
        }

        // ===== AUTO-REFRESH DOS PEDIDOS =====
        setInterval(async () => {
            if (currentSection === 'orders' || currentSection === 'dashboard') {
                await loadOrders();
                if (currentSection === 'dashboard') {
                    loadDashboard();
                }
            }
        }, 30000); // Atualiza a cada 30 segundos

        console.log('üéØ Admin script carregado!');
    </script>
</body>
</html>
